import { Component, ElementRef, Output, EventEmitter, ViewChild, Input, TemplateRef } from '@angular/core';
import { isInputOrTextAreaElement, getContentEditableCaretCoords } from './mention-utils';
import { getCaretCoordinates } from './caret-coords';
/**
 * Angular Mentions.
 * https://github.com/dmacfarlane/angular-mentions
 *
 * Copyright (c) 2016 Dan MacFarlane
 */
export class MentionListComponent {
    constructor(element) {
        this.element = element;
        this.labelKey = 'label';
        this.itemClick = new EventEmitter();
        this.items = [];
        this.activeIndex = 0;
        this.hidden = false;
        this.dropUp = false;
        this.styleOff = false;
        this.coords = { top: 0, left: 0 };
        this.offset = 0;
    }
    ngAfterContentChecked() {
        if (!this.itemTemplate) {
            this.itemTemplate = this.defaultItemTemplate;
        }
    }
    // lots of confusion here between relative coordinates and containers
    position(nativeParentElement, iframe = null) {
        if (isInputOrTextAreaElement(nativeParentElement)) {
            // parent elements need to have postition:relative for this to work correctly?
            this.coords = getCaretCoordinates(nativeParentElement, nativeParentElement.selectionStart, null);
            this.coords.top = nativeParentElement.offsetTop + this.coords.top - nativeParentElement.scrollTop;
            this.coords.left = nativeParentElement.offsetLeft + this.coords.left - nativeParentElement.scrollLeft;
            // getCretCoordinates() for text/input elements needs an additional offset to position the list correctly
            this.offset = this.getBlockCursorDimensions(nativeParentElement).height;
        }
        else if (iframe) {
            let context = { iframe: iframe, parent: iframe.offsetParent };
            this.coords = getContentEditableCaretCoords(context);
        }
        else {
            let doc = document.documentElement;
            let scrollLeft = (window.pageXOffset || doc.scrollLeft) - (doc.clientLeft || 0);
            let scrollTop = (window.pageYOffset || doc.scrollTop) - (doc.clientTop || 0);
            // bounding rectangles are relative to view, offsets are relative to container?
            let caretRelativeToView = getContentEditableCaretCoords({ iframe: iframe });
            let parentRelativeToContainer = nativeParentElement.getBoundingClientRect();
            this.coords.top = caretRelativeToView.top - parentRelativeToContainer.top + nativeParentElement.offsetTop - scrollTop;
            this.coords.left = caretRelativeToView.left - parentRelativeToContainer.left + nativeParentElement.offsetLeft - scrollLeft;
        }
        // set the default/inital position
        this.positionElement();
    }
    get activeItem() {
        return this.items[this.activeIndex];
    }
    activateNextItem() {
        // adjust scrollable-menu offset if the next item is out of view
        let listEl = this.list.nativeElement;
        let activeEl = listEl.getElementsByClassName('active').item(0);
        if (activeEl) {
            let nextLiEl = activeEl.nextSibling;
            if (nextLiEl && nextLiEl.nodeName == "LI") {
                let nextLiRect = nextLiEl.getBoundingClientRect();
                if (nextLiRect.bottom > listEl.getBoundingClientRect().bottom) {
                    listEl.scrollTop = nextLiEl.offsetTop + nextLiRect.height - listEl.clientHeight;
                }
            }
        }
        // select the next item
        this.activeIndex = Math.max(Math.min(this.activeIndex + 1, this.items.length - 1), 0);
    }
    activatePreviousItem() {
        // adjust the scrollable-menu offset if the previous item is out of view
        let listEl = this.list.nativeElement;
        let activeEl = listEl.getElementsByClassName('active').item(0);
        if (activeEl) {
            let prevLiEl = activeEl.previousSibling;
            if (prevLiEl && prevLiEl.nodeName == "LI") {
                let prevLiRect = prevLiEl.getBoundingClientRect();
                if (prevLiRect.top < listEl.getBoundingClientRect().top) {
                    listEl.scrollTop = prevLiEl.offsetTop;
                }
            }
        }
        // select the previous item
        this.activeIndex = Math.max(Math.min(this.activeIndex - 1, this.items.length - 1), 0);
    }
    // reset for a new mention search
    reset() {
        this.list.nativeElement.scrollTop = 0;
        this.checkBounds();
    }
    // final positioning is done after the list is shown (and the height and width are known)
    // ensure it's in the page bounds
    checkBounds() {
        let left = this.coords.left, top = this.coords.top, dropUp = this.dropUp;
        const bounds = this.list.nativeElement.getBoundingClientRect();
        // if off right of page, align right
        if (bounds.left + bounds.width > window.innerWidth) {
            left -= bounds.left + bounds.width - window.innerWidth + 10;
        }
        // if more than half off the bottom of the page, force dropUp
        // if ((bounds.top+bounds.height/2)>window.innerHeight) {
        //   dropUp = true;
        // }
        // if top is off page, disable dropUp
        if (bounds.top < 0) {
            dropUp = false;
        }
        // set the revised/final position
        this.positionElement(left, top, dropUp);
    }
    positionElement(left = this.coords.left, top = this.coords.top, dropUp = this.dropUp) {
        const el = this.element.nativeElement;
        top += dropUp ? 0 : this.offset; // top of list is next line
        el.className = dropUp ? 'dropup' : null;
        el.style.position = "absolute";
        el.style.left = left + 'px';
        el.style.top = top + 'px';
    }
    getBlockCursorDimensions(nativeParentElement) {
        const parentStyles = window.getComputedStyle(nativeParentElement);
        return {
            height: parseFloat(parentStyles.lineHeight),
            width: parseFloat(parentStyles.fontSize)
        };
    }
}
MentionListComponent.decorators = [
    { type: Component, args: [{
                selector: 'mention-list',
                template: `
    <ng-template #defaultItemTemplate let-item="item">
      {{item[labelKey]}}
    </ng-template>
    <ul #list [hidden]="hidden" class="dropdown-menu scrollable-menu"
      [class.mention-menu]="!styleOff" [class.mention-dropdown]="!styleOff && dropUp">
      <li *ngFor="let item of items; let i = index"
        [class.active]="activeIndex==i" [class.mention-active]="!styleOff && activeIndex==i">
        <a class="dropdown-item" [class.mention-item]="!styleOff"
          (mousedown)="activeIndex=i;itemClick.emit();$event.preventDefault()">
          <ng-template [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{'item':item}"></ng-template>
        </a>
      </li>
    </ul>
    `,
                styles: [".mention-menu{background-clip:padding-box;background-color:#fff;border:1px solid rgba(0,0,0,.15);border-radius:.25em;color:#212529;display:none;float:left;font-size:1em;left:0;list-style:none;margin:.125em 0 0;min-width:11em;padding:.5em 0;position:absolute;text-align:left;top:100%;z-index:1000}.mention-item{background-color:transparent;border:0;clear:both;color:#212529;display:block;font-weight:400;line-height:1.5em;padding:.2em 1.5em;text-align:inherit;white-space:nowrap}.mention-active>a{background-color:#337ab7;color:#fff;outline:0;text-decoration:none}.scrollable-menu{display:block;height:auto;max-height:292px;overflow:auto}[hidden]{display:none}.mention-dropdown{bottom:100%;margin-bottom:2px;top:auto}"]
            },] }
];
MentionListComponent.ctorParameters = () => [
    { type: ElementRef }
];
MentionListComponent.propDecorators = {
    labelKey: [{ type: Input }],
    itemTemplate: [{ type: Input }],
    itemClick: [{ type: Output }],
    list: [{ type: ViewChild, args: ['list', { static: true },] }],
    defaultItemTemplate: [{ type: ViewChild, args: ['defaultItemTemplate', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudGlvbi1saXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLW1lbnRpb25zL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9tZW50aW9uLWxpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQzNFLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSw2QkFBNkIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJEOzs7OztHQUtHO0FBb0JILE1BQU0sT0FBTyxvQkFBb0I7SUFhL0IsWUFBb0IsT0FBbUI7UUFBbkIsWUFBTyxHQUFQLE9BQU8sQ0FBWTtRQVo5QixhQUFRLEdBQVcsT0FBTyxDQUFDO1FBRTFCLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBR3pDLFVBQUssR0FBRyxFQUFFLENBQUM7UUFDWCxnQkFBVyxHQUFXLENBQUMsQ0FBQztRQUN4QixXQUFNLEdBQVksS0FBSyxDQUFDO1FBQ3hCLFdBQU0sR0FBWSxLQUFLLENBQUM7UUFDeEIsYUFBUSxHQUFZLEtBQUssQ0FBQztRQUNsQixXQUFNLEdBQThCLEVBQUMsR0FBRyxFQUFDLENBQUMsRUFBRSxJQUFJLEVBQUMsQ0FBQyxFQUFDLENBQUM7UUFDcEQsV0FBTSxHQUFXLENBQUMsQ0FBQztJQUNlLENBQUM7SUFFM0MscUJBQXFCO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDO1NBQzlDO0lBQ0gsQ0FBQztJQUVELHFFQUFxRTtJQUNyRSxRQUFRLENBQUMsbUJBQXFDLEVB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Q25ELEdBQUcsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLDJCQUEyQjtRQUM1RCxFQUFFLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDeEMsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsVUFBVSxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7UUFDNUIsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQztJQUM1QixDQUFDO0lBRU8sd0JBQXdCLENBQUMsbUJBQXFDO1FBQ3BFLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2xFLE9BQU87WUFDTCxNQUFNLEVBQUUsVUFBVSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFDM0MsS0FBSyxFQUFFLFVBQVUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO1NBQ3pDLENBQUM7SUFDSixDQUFDOzs7WUFwSkYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxjQUFjO2dCQUV4QixRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7O0tBY1A7O2FBQ0o7OztZQTlCWSxVQUFVOzs7dUJBZ0NwQixLQUFLOzJCQUNMLEtBQUs7d0JBQ0wsTUFBTTttQkFDTixTQUFTLFNBQUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtrQ0FDbEMsU0FBUyxTQUFDLHFCQUFxQixFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCwgRWxlbWVudFJlZiwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIFZpZXdDaGlsZCwgSW5wdXQsIFRlbXBsYXRlUmVmLCBBZnRlckNvbnRlbnRDaGVja2VkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQsIGdldENvbnRlbnRFZGl0YWJsZUNhcmV0Q29vcmRzIH0gZnJvbSAnLi9tZW50aW9uLXV0aWxzJztcbmltcG9ydCB7IGdldENhcmV0Q29vcmRpbmF0ZXMgfSBmcm9tICcuL2NhcmV0LWNvb3Jkcyc7XG5cbi8qKlxuICogQW5ndWxhciBNZW50aW9ucy5cbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9kbWFjZmFybGFuZS9hbmd1bGFyLW1lbnRpb25zXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDE2IERhbiBNYWNGYXJsYW5lXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ21lbnRpb24tbGlzdCcsXG4gIHN0eWxlVXJsczogWycuL21lbnRpb24tbGlzdC5jb21wb25lbnQuc2NzcyddLFxuICB0ZW1wbGF0ZTogYFxuICAgIDxuZy10ZW1wbGF0ZSAjZGVmYXVsdEl0ZW1UZW1wbGF0ZSBsZXQtaXRlbT1cIml0ZW1cIj5cbiAgICAgIHt7aXRlbVtsYWJlbEtleV19fVxuICAgIDwvbmctdGVtcGxhdGU+XG4gICAgPHVsICNsaXN0IFtoaWRkZW5dPVwiaGlkZGVuXCIgY2xhc3M9XCJkcm9wZG93bi1tZW51IHNjcm9sbGFibGUtbWVudVwiXG4gICAgICBbY2xhc3MubWVudGlvbi1tZW51XT1cIiFzdHlsZU9mZlwiIFtjbGFzcy5tZW50aW9uLWRyb3Bkb3duXT1cIiFzdHlsZU9mZiAmJiBkcm9wVXBcIj5cbiAgICAgIDxsaSAqbmdGb3I9XCJsZXQgaXRlbSBvZiBpdGVtczsgbGV0IGkgPSBpbmRleFwiXG4gICAgICAgIFtjbGFzcy5hY3RpdmVdPVwiYWN0aXZlSW5kZXg9PWlcIiBbY2xhc3MubWVudGlvbi1hY3RpdmVdPVwiIXN0eWxlT2ZmICYmIGFjdGl2ZUluZGV4PT1pXCI+XG4gICAgICAgIDxhIGNsYXNzPVwiZHJvcGRvd24taXRlbVwiIFtjbGFzcy5tZW50aW9uLWl0ZW1dPVwiIXN0eWxlT2ZmXCJcbiAgICAgICAgICAobW91c2Vkb3duKT1cImFjdGl2ZUluZGV4PWk7aXRlbUNsaWNrLmVtaXQoKTskZXZlbnQucHJldmVudERlZmF1bHQoKVwiPlxuICAgICAgICAgIDxuZy10ZW1wbGF0ZSBbbmdUZW1wbGF0ZU91dGxldF09XCJpdGVtVGVtcGxhdGVcIiBbbmdUZW1wbGF0ZU91dGxldENvbnRleHRdPVwieydpdGVtJzppdGVtfVwiPjwvbmctdGVtcGxhdGU+XG4gICAgICAgIDwvYT5cbiAgICAgIDwvbGk+XG4gICAgPC91bD5cbiAgICBgXG59KVxuZXhwb3J0IGNsYXNzIE1lbnRpb25MaXN0Q29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50Q2hlY2tlZCB7XG4gIEBJbnB1dCgpIGxhYmVsS2V5OiBzdHJpbmcgPSAnbGFiZWwnO1xuICBASW5wdXQoKSBpdGVtVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XG4gIEBPdXRwdXQoKSBpdGVtQ2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBWaWV3Q2hpbGQoJ2xpc3QnLCB7IHN0YXRpYzogdHJ1ZSB9KSBsaXN0OiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdkZWZhdWx0SXRlbVRlbXBsYXRlJywgeyBzdGF0aWM6IHRydWUgfSkgZGVmYXVsdEl0ZW1UZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PjtcbiAgaXRlbXMgPSBbXTtcbiAgYWN0aXZlSW5kZXg6IG51bWJlciA9IDA7XG4gIGhpZGRlbjogYm9vbGVhbiA9IGZhbHNlO1xuICBkcm9wVXA6IGJvb2xlYW4gPSBmYWxzZTtcbiAgc3R5bGVPZmY6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBjb29yZHM6IHt0b3A6bnVtYmVyLCBsZWZ0Om51bWJlcn0gPSB7dG9wOjAsIGxlZnQ6MH07XG4gIHByaXZhdGUgb2Zmc2V0OiBudW1iZXIgPSAwO1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnQ6IEVsZW1lbnRSZWYpIHt9XG5cbiAgbmdBZnRlckNvbnRlbnRDaGVja2VkKCkge1xuICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUpIHtcbiAgICAgIHRoaXMuaXRlbVRlbXBsYXRlID0gdGhpcy5kZWZhdWx0SXRlbVRlbXBsYXRlO1xuICAgIH1cbiAgfVxuXG4gIC8vIGxvdHMgb2YgY29uZnVzaW9uIGhlcmUgYmV0d2VlbiByZWxhdGl2ZSBjb29yZGluYXRlcyBhbmQgY29udGFpbmVyc1xuICBwb3NpdGlvbihuYXRpdmVQYXJlbnRFbGVtZW50OiBIVE1MSW5wdXRFbGVtZW50LCBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50ID0gbnVsbCkge1xuICAgIGlmIChpc0lucHV0T3JUZXh0QXJlYUVsZW1lbnQobmF0aXZlUGFyZW50RWxlbWVudCkpIHtcbiAgICAgIC8vIHBhcmVudCBlbGVtZW50cyBuZWVkIHRvIGhhdmUgcG9zdGl0aW9uOnJlbGF0aXZlIGZvciB0aGlzIHRvIHdvcmsgY29ycmVjdGx5P1xuICAgICAgdGhpcy5jb29yZHMgPSBnZXRDYXJldENvb3JkaW5hdGVzKG5hdGl2ZVBhcmVudEVsZW1lbnQsIG5hdGl2ZVBhcmVudEVsZW1lbnQuc2VsZWN0aW9uU3RhcnQsIG51bGwpO1xuICAgICAgdGhpcy5jb29yZHMudG9wID0gbmF0aXZlUGFyZW50RWxlbWVudC5vZmZzZXRUb3AgKyB0aGlzLmNvb3Jkcy50b3AgLSBuYXRpdmVQYXJlbnRFbGVtZW50LnNjcm9sbFRvcDtcbiAgICAgIHRoaXMuY29vcmRzLmxlZnQgPSBuYXRpdmVQYXJlbnRFbGVtZW50Lm9mZnNldExlZnQgKyB0aGlzLmNvb3Jkcy5sZWZ0IC0gbmF0aXZlUGFyZW50RWxlbWVudC5zY3JvbGxMZWZ0O1xuICAgICAgLy8gZ2V0Q3JldENvb3JkaW5hdGVzKCkgZm9yIHRleHQvaW5wdXQgZWxlbWVudHMgbmVlZHMgYW4gYWRkaXRpb25hbCBvZmZzZXQgdG8gcG9zaXRpb24gdGhlIGxpc3QgY29ycmVjdGx5XG4gICAgICB0aGlzLm9mZnNldCA9IHRoaXMuZ2V0QmxvY2tDdXJzb3JEaW1lbnNpb25zKG5hdGl2ZVBhcmVudEVsZW1lbnQpLmhlaWdodDtcbiAgICB9XG4gICAgZWxzZSBpZiAoaWZyYW1lKSB7XG4gICAgICBsZXQgY29udGV4dDogeyBpZnJhbWU6IEhUTUxJRnJhbWVFbGVtZW50LCBwYXJlbnQ6IEVsZW1lbnQgfSA9IHsgaWZyYW1lOiBpZnJhbWUsIHBhcmVudDogaWZyYW1lLm9mZnNldFBhcmVudCB9O1xuICAgICAgdGhpcy5jb29yZHMgPSBnZXRDb250ZW50RWRpdGFibGVDYXJldENvb3Jkcyhjb250ZXh0KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBsZXQgZG9jID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgbGV0IHNjcm9sbExlZnQgPSAod2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0KSAtIChkb2MuY2xpZW50TGVmdCB8fCAwKTtcbiAgICAgIGxldCBzY3JvbGxUb3AgPSAod2luZG93LnBhZ2VZT2Zmc2V0IHx8IGRvYy5zY3JvbGxUb3ApIC0gKGRvYy5jbGllbnRUb3AgfHwgMCk7XG4gICAgICAvLyBib3VuZGluZyByZWN0YW5nbGVzIGFyZSByZWxhdGl2ZSB0byB2aWV3LCBvZmZzZXRzIGFyZSByZWxhdGl2ZSB0byBjb250YWluZXI/XG4gICAgICBsZXQgY2FyZXRSZWxhdGl2ZVRvVmlldyA9IGdldENvbnRlbnRFZGl0YWJsZUNhcmV0Q29vcmRzKHsgaWZyYW1lOiBpZnJhbWUgfSk7XG4gICAgICBsZXQgcGFyZW50UmVsYXRpdmVUb0NvbnRhaW5lcjogQ2xpZW50UmVjdCA9IG5hdGl2ZVBhcmVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICB0aGlzLmNvb3Jkcy50b3AgPSBjYXJldFJlbGF0aXZlVG9WaWV3LnRvcCAtIHBhcmVudFJlbGF0aXZlVG9Db250YWluZXIudG9wICsgbmF0aXZlUGFyZW50RWxlbWVudC5vZmZzZXRUb3AgLSBzY3JvbGxUb3A7XG4gICAgICB0aGlzLmNvb3Jkcy5sZWZ0ID0gY2FyZXRSZWxhdGl2ZVRvVmlldy5sZWZ0IC0gcGFyZW50UmVsYXRpdmVUb0NvbnRhaW5lci5sZWZ0ICsgbmF0aXZlUGFyZW50RWxlbWVudC5vZmZzZXRMZWZ0IC0gc2Nyb2xsTGVmdDtcbiAgICB9XG4gICAgLy8gc2V0IHRoZSBkZWZhdWx0L2luaXRhbCBwb3NpdGlvblxuICAgIHRoaXMucG9zaXRpb25FbGVtZW50KCk7XG4gIH1cblxuICBnZXQgYWN0aXZlSXRlbSgpIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1t0aGlzLmFjdGl2ZUluZGV4XTtcbiAgfVxuXG4gIGFjdGl2YXRlTmV4dEl0ZW0oKSB7XG4gICAgLy8gYWRqdXN0IHNjcm9sbGFibGUtbWVudSBvZmZzZXQgaWYgdGhlIG5leHQgaXRlbSBpcyBvdXQgb2Ygdmlld1xuICAgIGxldCBsaXN0RWw6IEhUTUxFbGVtZW50ID0gdGhpcy5saXN0Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgbGV0IGFjdGl2ZUVsID0gbGlzdEVsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2FjdGl2ZScpLml0ZW0oMCk7XG4gICAgaWYgKGFjdGl2ZUVsKSB7XG4gICAgICBsZXQgbmV4dExpRWw6IEhUTUxFbGVtZW50ID0gPEhUTUxFbGVtZW50PiBhY3RpdmVFbC5uZXh0U2libGluZztcbiAgICAgIGlmIChuZXh0TGlFbCAmJiBuZXh0TGlFbC5ub2RlTmFtZSA9PSBcIkxJXCIpIHtcbiAgICAgICAgbGV0IG5leHRMaVJlY3Q6IENsaWVudFJlY3QgPSBuZXh0TGlFbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgaWYgKG5leHRMaVJlY3QuYm90dG9tID4gbGlzdEVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbSkge1xuICAgICAgICAgIGxpc3RFbC5zY3JvbGxUb3AgPSBuZXh0TGlFbC5vZmZzZXRUb3AgKyBuZXh0TGlSZWN0LmhlaWdodCAtIGxpc3RFbC5jbGllbnRIZWlnaHQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8gc2VsZWN0IHRoZSBuZXh0IGl0ZW1cbiAgICB0aGlzLmFjdGl2ZUluZGV4ID0gTWF0aC5tYXgoTWF0aC5taW4odGhpcy5hY3RpdmVJbmRleCArIDEsIHRoaXMuaXRlbXMubGVuZ3RoIC0gMSksIDApO1xuICB9XG5cbiAgYWN0aXZhdGVQcmV2aW91c0l0ZW0oKSB7XG4gICAgLy8gYWRqdXN0IHRoZSBzY3JvbGxhYmxlLW1lbnUgb2Zmc2V0IGlmIHRoZSBwcmV2aW91cyBpdGVtIGlzIG91dCBvZiB2aWV3XG4gICAgbGV0IGxpc3RFbDogSFRNTEVsZW1lbnQgPSB0aGlzLmxpc3QubmF0aXZlRWxlbWVudDtcbiAgICBsZXQgYWN0aXZlRWwgPSBsaXN0RWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYWN0aXZlJykuaXRlbSgwKTtcbiAgICBpZiAoYWN0aXZlRWwpIHtcbiAgICAgIGxldCBwcmV2TGlFbDogSFRNTEVsZW1lbnQgPSA8SFRNTEVsZW1lbnQ+IGFjdGl2ZUVsLnByZXZpb3VzU2libGluZztcbiAgICAgIGlmIChwcmV2TGlFbCAmJiBwcmV2TGlFbC5ub2RlTmFtZSA9PSBcIkxJXCIpIHtcbiAgICAgICAgbGV0IHByZXZMaVJlY3Q6IENsaWVudFJlY3QgPSBwcmV2TGlFbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgaWYgKHByZXZMaVJlY3QudG9wIDwgbGlzdEVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCkge1xuICAgICAgICAgIGxpc3RFbC5zY3JvbGxUb3AgPSBwcmV2TGlFbC5vZmZzZXRUb3A7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8gc2VsZWN0IHRoZSBwcmV2aW91cyBpdGVtXG4gICAgdGhpcy5hY3RpdmVJbmRleCA9IE1hdGgubWF4KE1hdGgubWluKHRoaXMuYWN0aXZlSW5kZXggLSAxLCB0aGlzLml0ZW1zLmxlbmd0aCAtIDEpLCAwKTtcbiAgfVxuXG4gIC8vIHJlc2V0IGZvciBhIG5ldyBtZW50aW9uIHNlYXJjaFxuICByZXNldCgpIHtcbiAgICB0aGlzLmxpc3QubmF0aXZlRWxlbWVudC5zY3JvbGxUb3AgPSAwO1xuICAgIHRoaXMuY2hlY2tCb3VuZHMoKTtcbiAgfVxuXG4gIC8vIGZpbmFsIHBvc2l0aW9uaW5nIGlzIGRvbmUgYWZ0ZXIgdGhlIGxpc3QgaXMgc2hvd24gKGFuZCB0aGUgaGVpZ2h0IGFuZCB3aWR0aCBhcmUga25vd24pXG4gIC8vIGVuc3VyZSBpdCdzIGluIHRoZSBwYWdlIGJvdW5kc1xuICBwcml2YXRlIGNoZWNrQm91bmRzKCkge1xuICAgIGxldCBsZWZ0ID0gdGhpcy5jb29yZHMubGVmdCwgdG9wID0gdGhpcy5jb29yZHMudG9wLCBkcm9wVXAgPSB0aGlzLmRyb3BVcDtcbiAgICBjb25zdCBib3VuZHM6IENsaWVudFJlY3QgPSB0aGlzLmxpc3QubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAvLyBpZiBvZmYgcmlnaHQgb2YgcGFnZSwgYWxpZ24gcmlnaHRcbiAgICBpZiAoYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGggPiB3aW5kb3cuaW5uZXJXaWR0aCkge1xuICAgICAgbGVmdCAtPSBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCAtIHdpbmRvdy5pbm5lcldpZHRoICsgMTA7XG4gICAgfVxuICAgIC8vIGlmIG1vcmUgdGhhbiBoYWxmIG9mZiB0aGUgYm90dG9tIG9mIHRoZSBwYWdlLCBmb3JjZSBkcm9wVXBcbiAgICAvLyBpZiAoKGJvdW5kcy50b3ArYm91bmRzLmhlaWdodC8yKT53aW5kb3cuaW5uZXJIZWlnaHQpIHtcbiAgICAvLyAgIGRyb3BVcCA9IHRydWU7XG4gICAgLy8gfVxuICAgIC8vIGlmIHRvcCBpcyBvZmYgcGFnZSwgZGlzYWJsZSBkcm9wVXBcbiAgICBpZiAoYm91bmRzLnRvcDwwKSB7XG4gICAgICBkcm9wVXAgPSBmYWxzZTtcbiAgICB9XG4gICAgLy8gc2V0IHRoZSByZXZpc2VkL2ZpbmFsIHBvc2l0aW9uXG4gICAgdGhpcy5wb3NpdGlvbkVsZW1lbnQobGVmdCwgdG9wLCBkcm9wVXApO1xuICB9XG5cbiAgcHJpdmF0ZSBwb3NpdGlvbkVsZW1lbnQobGVmdDpudW1iZXI9dGhpcy5jb29yZHMubGVmdCwgdG9wOm51bWJlcj10aGlzLmNvb3Jkcy50b3AsIGRyb3BVcDpib29sZWFuPXRoaXMuZHJvcFVwKSB7XG4gICAgY29uc3QgZWw6IEhUTUxFbGVtZW50ID0gdGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQ7XG4gICAgdG9wICs9IGRyb3BVcCA/IDAgOiB0aGlzLm9mZnNldDsgLy8gdG9wIG9mIGxpc3QgaXMgbmV4dCBsaW5lXG4gICAgZWwuY2xhc3NOYW1lID0gZHJvcFVwID8gJ2Ryb3B1cCcgOiBudWxsO1xuICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuICAgIGVsLnN0eWxlLmxlZnQgPSBsZWZ0ICsgJ3B4JztcbiAgICBlbC5zdHlsZS50b3AgPSB0b3AgKyAncHgnO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRCbG9ja0N1cnNvckRpbWVuc2lvbnMobmF0aXZlUGFyZW50RWxlbWVudDogSFRNTElucHV0RWxlbWVudCkge1xuICAgIGNvbnN0IHBhcmVudFN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG5hdGl2ZVBhcmVudEVsZW1lbnQpO1xuICAgIHJldHVybiB7XG4gICAgICBoZWlnaHQ6IHBhcnNlRmxvYXQocGFyZW50U3R5bGVzLmxpbmVIZWlnaHQpLFxuICAgICAgd2lkdGg6IHBhcnNlRmxvYXQocGFyZW50U3R5bGVzLmZvbnRTaXplKVxuICAgIH07XG4gIH1cbn1cbiJdfQ==